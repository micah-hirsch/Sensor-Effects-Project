---
title: "Sensor Effects Analysis"
author: "Micah Hirsch"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

The following report documents the data analysis conducted for the sensor effects project.

All data analyses were conducted using R version 4.3.2.

```{r, echo = F, warning = F, message = F}

# Loading in the needed packages and data
library(rio) # install.packages("rio") 
library(tidyverse) # install.packages("tidyverse")
library(geometry) # install.packages("geometry")
library(patchwork) # install.packages("patchwork")
library(NatParksPalettes) # install.packages("NatParksPalettes")
library(glmmTMB) # install.packages("glmmTMB")
library(emmeans) # install.packages("emmeans")
library(lme4) # install.packages("lme4")
library(lmerTest) # install.packages("lmerTest")
library(gt) # install.packages("gt")
library(gtsummary) # install.packages("gtsummary")
library(sjPlot) # install.packages("sjPlot")
library(ggpubr) # install.packages("ggpubr")

vowels <- rio::import("vowel_measures.csv") |>
  dplyr::mutate(time_point = factor(time_point, levels = c("before", "sensors", "after")),
                group = factor(group, levels = c("Control", "PD")),
                sex = factor(sex, levels = c("Male", "Female")),
                vowel = factor(vowel, levels = c("i", "u", "ae", "a")),
                seg_type = factor(seg_type, levels = c("initial", "intrarater", "interrater")))

consonants <- rio::import("consonant_measures.csv") |>
   dplyr::mutate(time_point = factor(time_point, levels = c("before", "sensors", "after")),
                group = factor(group, levels = c("Control", "PD")),
                sex = factor(sex, levels = c("Male", "Female")),
                consonant = factor(consonant, levels = c("s", "sh")),
                seg_type = factor(seg_type, levels = c("initial", "intrarater", "interrater")))

artic_rate <- rio::import("articulation_rate.csv") |>
  dplyr::mutate(time_point = factor(time_point, levels = c("before", "sensors", "after")),
                group = factor(group, levels = c("Control", "PD")), 
                sex = factor(sex, levels = c("Male", "Female")),
                phrase = as.factor(phrase),
                seg_type = factor(seg_type, levels = c("initial", "intrarater", "interrater")))

speakers <- artic_rate |>
  dplyr::select(speaker_id, group, sex, age) |>
  dplyr::distinct()

perceptual_data <- rio::import("perceptual_ratings.csv") |>
  dplyr::mutate(counterbalance = as.factor(counterbalance),
                time_point = factor(time_point, levels = c("before", "sensors", "after")),
                reliability = factor(reliability, levels = c("initial", "reliability")),
                rating_type = factor(rating_type, levels = c("intelligibility", "naturalness")))

listener_demo <- rio::import("listener_demographics.csv") |>
  dplyr::mutate(english = as.factor(english),
                age = as.numeric(age),
                gender = as.factor(gender),
                race = as.factor(race),
                ethnicity = as.factor(ethnicity))

```


# Articulation Rate

## Reliability

### Interrater Reliability

```{r, warning = F, message = F}

artic_rate_rel <- artic_rate |>
  tidyr::pivot_wider(names_from = seg_type,
                     values_from = artic_rate)

ar_inter <- artic_rate_rel |>
  dplyr::select(-intrarater) |>
  dplyr::filter(!is.na(interrater))

cor.test(ar_inter$initial, ar_inter$interrater, method = "pearson", use = "complete.obs")

```

### Intrarater Reliability

```{r, warning = F, message = F}

ar_intra <- artic_rate_rel |>
  dplyr::select(-interrater) |>
  dplyr::filter(!is.na(intrarater))

cor.test(ar_intra$initial, ar_intra$intrarater, method = "pearson", use = "complete.obs")

```

```{r, echo = F, warning = F, message = F}

rm(ar_inter, ar_intra, artic_rate_rel)

```


## Descriptives

```{r, warning = F, message = F}

ar_mod <- artic_rate |>
  dplyr::filter(seg_type == "initial") |>
  dplyr::group_by(speaker_id, time_point) |>
  dplyr::summarize(artic_rate_m = mean(artic_rate)) |>
  dplyr::left_join(speakers, by = "speaker_id") |>
  ungroup()

ar_mod |>
  dplyr::select(c(group, time_point, artic_rate_m)) |>
  tbl_strata(
    strata = group,
    ~.x |>
      tbl_summary(
        by = time_point,
        statistic = list(all_continuous() ~ c("{mean} ({sd})")),
        digits = all_continuous() ~ 2,
        label = list(artic_rate_m ~ "Articulation Rate")
      ))

```


## Plot

```{r, warning = F, message = F}

my_pal <- natparks.pals("Denali", 6)

overall_ar <- ar_mod |>
  dplyr::group_by(group, time_point) |>
  dplyr::summarize(artic_rate = mean(artic_rate_m), sd = sd(artic_rate_m), se = sd/sqrt(n())) |>
  dplyr::ungroup()

artic_rate_plot <- overall_ar |>
  ggplot() +
  aes(x = time_point,
      y = artic_rate,
      color = group,
      group = group) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = artic_rate - se, ymax = artic_rate + se)) +
  labs(x = "Time Point",
       y = "Articulation Rate (syl/s)") +
  scale_color_manual(values = c(my_pal[1], my_pal[4])) +
  theme_classic() +
  theme(legend.position = "bottom",
        aspect.ratio = 1)

artic_rate_plot

ggsave("Figures/artic_rate_plot.png", plot = last_plot(), width = 5, height = 5, units = "in")

```

## Model

### Model Summary

```{r, warning = F, message = F}

ar_model <- lmer(artic_rate_m ~ time_point*group + (1|speaker_id), data = ar_mod)
summary(ar_model)

sjPlot::tab_model(ar_model)

```


### Pairwise Comparisons

```{r, warning = F, message = F}

emm_artic_rate <- emmeans(ar_model, specs = pairwise ~ time_point:group)
emm_artic_rate$contrasts

```

```{r, warning = F, message = F}

rm(ar_model, ar_mod, emm_artic_rate, overall_ar)

```


# Vowel Space Area

## Reliability

### Interrater Reliability

```{r, warning = F, message = F}

VSA_coords <- vowels |>
  dplyr::group_by(speaker_id, time_point, vowel, seg_type) |>
  dplyr::summarize(F1 = mean(f1),
                   F2 = mean(f2)) |>
  dplyr::ungroup()

VSA <- VSA_coords |>
  dplyr::group_by(speaker_id, time_point, seg_type) |>
  dplyr::mutate(VSA = (geometry::polyarea(F1, F2))/1000) |> # Converted to kHz
  dplyr::select(!c(vowel, F1, F2)) |>
  dplyr::distinct() |>
  dplyr::left_join(speakers, by = "speaker_id") |>
  ungroup()

VSA_rel <- VSA |>
  tidyr::pivot_wider(names_from = seg_type,
                     values_from = VSA)

VSA_inter <- VSA_rel |>
  dplyr::select(-intrarater) |>
  dplyr::filter(!is.na(interrater))

cor.test(VSA_inter$initial, VSA_inter$interrater, method = "pearson", use = "complete.obs")

```
### Intrarater Reliability

```{r, warning = F, message = F}

VSA_intra <- VSA_rel |>
  dplyr::select(-interrater) |>
  dplyr::filter(!is.na(intrarater))

cor.test(VSA_intra$initial, VSA_intra$intrarater, method = "pearson", use = "complete.obs")

```

```{r, echo = F, warning = F, message = F}

rm(VSA_rel, VSA_intra, VSA_inter, VSA_coords)

```


## Descriptives

```{r, warning = F, message = F}

VSA_mod <- VSA |>
  dplyr::filter(seg_type == "initial")

VSA_mod |>
  dplyr::select(c(group, time_point, VSA)) |>
  tbl_strata(
    strata = group,
    ~.x |>
      tbl_summary(
        by = time_point,
        statistic = list(all_continuous() ~ c("{mean} ({sd})")),
        digits = all_continuous() ~ 2
      ))

```


## Plot

```{r, warning = F, message = F}

VSA_overall <- VSA_mod |>
  dplyr::group_by(group, time_point) |>
  dplyr::summarize(VSA_mean = mean(VSA), VSA_sd = sd(VSA), se = VSA_sd/sqrt(n()))

VSA_plot <- VSA_overall |>
  ggplot() +
  aes(x = time_point,
      y = VSA_mean,
      group = group,
      color = group) +
  geom_point() +
  geom_line() +
  geom_errorbar(
    aes(
      ymin = VSA_mean - se,
      ymax = VSA_mean + se),
    width = .1
    ) +
  scale_color_manual(values = c(my_pal[1], my_pal[4])) +
  labs(
    x = "",
    y = bquote('Vowel Space Area '(kHz^2))) +
  theme_classic() +
  theme(legend.position = "bottom",
        aspect.ratio = 1)

VSA_plot

ggsave("Figures/VSA_plot.png", plot = last_plot(), width = 5, height = 5, units = "in")


```

## Model

### Model Summary

```{r, warning = F, message = F}

VSA_model <- lmer(VSA ~ time_point*group + (1|speaker_id), data = VSA_mod)
summary(VSA_model)

sjPlot::tab_model(VSA_model)

```

# Spectral Moment Analysis

## Reliability

### Interrater Reliability

#### M1

```{r, warning = F, message = F}

moment_mod <- consonants |>
  dplyr::select(speaker_id, group, sex, age, time_point, seg_type, consonant, m1, m2) |>
  dplyr::group_by(speaker_id, time_point, consonant, seg_type) |>
  dplyr::summarize(M1 = mean(m1), M2 = mean(m2)) |>
  dplyr::ungroup() |>
  dplyr::left_join(speakers, by = "speaker_id")
  

M1_rel <- moment_mod|>
  dplyr::select(speaker_id, group, sex, age, time_point, seg_type, consonant, M1) |>
  tidyr::pivot_wider(names_from = seg_type,
                     values_from = M1)


M1_inter <- M1_rel |>
  dplyr::select(-intrarater) |>
  dplyr::filter(!is.na(interrater))

cor.test(M1_inter$initial, M1_inter$interrater, method = "pearson", use = "complete.obs")

```
#### M2

```{r, warning = F, message = F}

M2_rel <- moment_mod|>
  dplyr::select(speaker_id, group, sex, age, time_point, seg_type, consonant, M2) |>
  tidyr::pivot_wider(names_from = seg_type,
                     values_from = M2)


M2_inter <- M2_rel |>
  dplyr::select(-intrarater) |>
  dplyr::filter(!is.na(interrater))

cor.test(M2_inter$initial, M2_inter$interrater, method = "pearson", use = "complete.obs")

```


### Intrarater

#### M1

```{r, warning = F, message = F}

M1_intra <- M1_rel |>
  dplyr::select(-interrater) |>
  dplyr::filter(!is.na(intrarater))

cor.test(M1_intra$initial, M1_intra$intrarater, method = "pearson", use = "complete.obs")

```

#### M2

```{r, warning = F, message = F}

M2_intra <- M2_rel |>
  dplyr::select(-interrater) |>
  dplyr::filter(!is.na(intrarater))

cor.test(M2_intra$initial, M2_intra$intrarater, method = "pearson", use = "complete.obs")

```

## Descriptives

### Spectral Moment Coefficient for /s/

```{r, warning = F, message = F}

moment_mod <- moment_mod |>
  dplyr::filter(seg_type == "initial")

moment_mod |>
  dplyr::filter(consonant == "s") |>
  dplyr::select(c(group, time_point, M1, M2)) |>
  tbl_strata(
    strata = group,
    ~.x |>
      tbl_summary(
        by = time_point,
        statistic = list(all_continuous() ~ c("{mean} ({sd})")),
        digits = all_continuous() ~ 2
      ))

```

### Spectral Moment for /sh/

```{r, warning = F, message = F}

moment_mod |>
  dplyr::filter(consonant == "sh") |>
  dplyr::select(c(group, time_point, M1, M2)) |>
  tbl_strata(
    strata = group,
    ~.x |>
      tbl_summary(
        by = time_point,
        statistic = list(all_continuous() ~ c("{mean} ({sd})")),
        digits = all_continuous() ~ 2
      ))

```


## Plot

### M1

```{r, warning = F, message = F}

M1_des <- moment_mod |>
  dplyr::group_by(group, time_point, consonant) |>
  dplyr::summarize(Mean_M1 = mean(M1), sd = sd(M1), se = sd/sqrt(n()))

M1_plot <- M1_des |>
  ggplot() +
  aes(x = time_point,
      y = Mean_M1,
      group = group,
      color = group) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = Mean_M1 - se, ymax = Mean_M1 + se), width = 0.1) +
  labs(x = "",
       y = "M1 (kHz)") +
  scale_color_manual(values = c(my_pal[1], my_pal[4])) +
  facet_wrap("consonant") +
  theme_classic() +
  theme(aspect.ratio = 1)

M1_plot

```


### M2

```{r, warning = F, message = F}

M2_des <- moment_mod |>
  dplyr::group_by(group, time_point, consonant) |>
  dplyr::summarize(Mean_M2 = mean(M2), sd = sd(M2), se = sd/sqrt(n()))

M2_plot <- M2_des |>
  ggplot() +
  aes(x = time_point,
      y = Mean_M2,
      group = group,
      color = group) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = Mean_M2 - se, ymax = Mean_M2 + se), width = 0.1) +
  labs(x = "",
       y = "M2 (kHz)") +
  scale_color_manual(values = c(my_pal[1], my_pal[4])) +
  facet_wrap("consonant") +
  theme_classic() +
  theme(aspect.ratio = 1)

M2_plot

```
## Models

### Spectral Moment Coefficient for /s/

#### M1

```{r, warning = F, message = F}

moment_mod_s <- moment_mod |>
  dplyr::filter(consonant == "s")

M1_s_mod <- lmer(M1 ~ time_point*group + (1|speaker_id), data = moment_mod_s)
summary(M1_s_mod)

sjPlot::tab_model(M1_s_mod)

```


```{r}

emm_M1_s <- emmeans(M1_s_mod, specs = pairwise ~ time_point:group)
emm_M1_s$contrasts

```



#### M2

```{r, warning = F, message = F}


M2_s_mod <- lmer(M2 ~ time_point*group + (1|speaker_id), data = moment_mod_s)
summary(M2_s_mod)

sjPlot::tab_model(M2_s_mod)

```


### Spectral Moment Coefficient for /sh/

#### M1 

```{r, warning = F, message = F}

moment_mod_sh <- moment_mod |>
  dplyr::filter(consonant == "sh")

M1_sh_mod <- lmer(M1 ~ time_point*group + (1|speaker_id), data = moment_mod_sh)
summary(M1_sh_mod)

sjPlot::tab_model(M1_sh_mod)

```


#### M2

```{r, warning = F, message = F}

M2_sh_mod <- lmer(M2 ~ time_point*group + (1|speaker_id), data = moment_mod_sh)
summary(M2_sh_mod)

sjPlot::tab_model(M2_sh_mod)

```

# Listener Demographics

```{r, warning = F, message = F}

listener_demo |>
  select(-c(listener_id, english)) |>
  tbl_summary(type = list(age ~ "continuous",
                          gender ~ "categorical",
                          race ~ "categorical",
                          ethnicity ~ "categorical"),
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              digits = list(everything() ~ c(2)),
              label = list(age ~ "Age",
                           gender ~ "Gender",
                           race ~ "Race",
                           ethnicity ~ "Ethnicity")) |>
  as_gt()

```


# Intelligibility

## Intrarater Reliability

```{r, warning = F, message = F}

intel_initial <- perceptual_data |>
  dplyr::filter(rating_type == "intelligibility") |>
  dplyr::filter(reliability == "initial")

intel_rel <- perceptual_data |>
  dplyr::filter(rating_type == "intelligibility") |>
  dplyr::filter(reliability == "reliability") |>
  dplyr::select(listener_id, speaker_id, time_point, cp_section, rating) |>
  dplyr::rename(rating_rel = rating)

intel <- left_join(intel_initial, intel_rel, by = c("listener_id", "speaker_id", 
                                                   "time_point", "cp_section")) |>
  dplyr::filter(!is.na(rating_rel))

cor.test(intel$rating, intel$rating_rel, method = "pearson", use = "complete.obs")

```

## Descriptives

```{r}

speaker_intel <- intel_initial |>
  dplyr::group_by(speaker_id, time_point) |>
  dplyr::summarize(intel = mean(rating)) |>
  ungroup() |>
  dplyr::left_join(speakers, by = "speaker_id")

speaker_intel |>
  dplyr::select(group, time_point, intel) |>
  tbl_strata(
    strata = group,
    ~.x |>
      tbl_summary(
        by = time_point,
        statistic = list(all_continuous() ~ c("{mean} ({sd})")),
        digits = all_continuous() ~ 2,
        label = list(intel ~ "Intelligibility")
      ))

```

## Plot

```{r}

speaker_intel_des <- speaker_intel |>
  dplyr::group_by(group, time_point) |>
  dplyr::summarize(intel_m = mean(intel), sd = sd(intel), se = sd/sqrt(n()))

intel_plot <- speaker_intel_des |>
  ggplot() +
  aes(x = time_point,
      y = intel_m,
      color = group,
      group = group) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = intel_m - se, ymax = intel_m + se)) +
  labs(x = "Time Point",
       y = "Intelligibility") +
  scale_color_manual(values = c(my_pal[1], my_pal[4])) +
  coord_cartesian(ylim = c(40, 100)) +
  theme_classic()

intel_plot

```

## Model

```{r, warning = F, message = F}

intel_mod <- lmer(intel ~ time_point*group + (1|speaker_id), data = speaker_intel)
summary(intel_mod)

sjPlot::tab_model(intel_mod)

```

# Naturalness

## Intrarater Reliability

```{r}

nat_initial <- perceptual_data |>
  dplyr::filter(rating_type == "naturalness") |>
  dplyr::filter(reliability == "initial")

nat_rel <- perceptual_data |>
  dplyr::filter(rating_type == "naturalness") |>
  dplyr::filter(reliability == "reliability") |>
  dplyr::select(listener_id, speaker_id, time_point, cp_section, rating) |>
  dplyr::rename(rating_rel = rating)

nat <- left_join(nat_initial, nat_rel, by = c("listener_id", "speaker_id", 
                                                   "time_point", "cp_section")) |>
  dplyr::filter(!is.na(rating_rel))

cor.test(nat$rating, nat$rating_rel, method = "pearson", use = "complete.obs")

```

## Descriptives

```{r}

speaker_nat <- nat_initial |>
  dplyr::group_by(speaker_id, time_point) |>
  dplyr::summarize(nat = mean(rating)) |>
  ungroup() |>
  dplyr::left_join(speakers, by = "speaker_id")

speaker_nat |>
  dplyr::select(group, time_point, nat) |>
  tbl_strata(
    strata = group,
    ~.x |>
      tbl_summary(
        by = time_point,
        statistic = list(all_continuous() ~ c("{mean} ({sd})")),
        digits = all_continuous() ~ 2,
        label = list(nat ~ "Naturalness")
      ))


```

## Plot

```{r}

speaker_nat_des <- speaker_nat |>
  dplyr::group_by(group, time_point) |>
  dplyr::summarize(nat_m = mean(nat), sd = sd(nat), se = sd/sqrt(n()))

nat_plot <- speaker_nat_des |>
  ggplot() +
  aes(x = time_point,
      y = nat_m,
      color = group,
      group = group) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = nat_m - se, ymax = nat_m + se)) +
  labs(x = "Time Point",
       y = "Naturalness") +
  scale_color_manual(values = c(my_pal[1], my_pal[4])) +
  coord_cartesian(ylim = c(40, 100)) +
  theme_classic()

nat_plot

```

## Model

```{r}

nat_mod <- lmer(nat ~ time_point*group + (1|speaker_id), data = speaker_nat)
summary(nat_mod)

sjPlot::tab_model(nat_mod)

```

```{r}

# Creating Spectral Moment Figure

ggarrange(M1_plot, M2_plot, ncol = 1, common.legend = T, legend = "bottom")

# Saving Spectral Moment Figure

ggsave("Figures/consonant_plot.png", plot = last_plot(), width = 6, height = 6, unit = "in")

```

```{r}

# Creating Perceptual Figure

speaker_intel_des <- speaker_intel_des |>
  dplyr::mutate(rating_type = "Intelligibility") |>
  dplyr::rename(rating = intel_m)

speaker_nat_des <- speaker_nat_des |>
  dplyr::mutate(rating_type = "Naturalness") |>
  dplyr::rename(rating = nat_m)

plot_df <- rbind(speaker_intel_des, speaker_nat_des)

plot_df |>
  ggplot() +
  aes(x = time_point,
      y = rating,
      color = group,
      group = group) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = rating - se, ymax = rating + se)) +
  labs(x = "Time Point",
       y = "Rating") +
  scale_color_manual(values = c(my_pal[1], my_pal[4])) +
  facet_wrap("rating_type") +
  theme_classic() +
  theme(legend.position = "bottom", 
        aspect.ratio = 1)


ggsave("Figures/perceptual_plot.png", plot = last_plot(), width = 6, height = 4, units = "in")

```


